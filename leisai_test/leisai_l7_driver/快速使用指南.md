# 雷赛L7伺服驱动器 - 快速使用指南

## 一、5分钟快速上手

### 1. 安装驱动库

```bash
pip install pyserial
```

### 2. 最简单的例子

```python
from leisai import L7Driver

# 连接伺服（Windows用COM3，Linux用/dev/ttyUSB0）
driver = L7Driver('COM3')
driver.connect()

# 读取状态
print(f"当前位置：{driver.get_position()} 脉冲")
print(f"当前速度：{driver.get_speed()} RPM")

# 断开连接
driver.disconnect()
```

### 3. 使用with语句（推荐）

```python
from leisai import L7Driver

with L7Driver('COM3') as driver:
    # 自动连接和断开
    driver.servo_on()         # 使能
    print(driver.get_position())
    driver.servo_off()        # 断使能
```

## 二、常用操作示例

### 🟢 伺服使能/断使能

```python
with L7Driver('COM3') as driver:
    # 使能
    driver.servo_on()
    print("伺服已使能")
    
    # 你的操作...
    
    # 断使能
    driver.servo_off()
    print("伺服已断使能")
```

### 📍 读取位置

```python
with L7Driver('COM3') as driver:
    position = driver.get_position()  # 脉冲数
    print(f"当前位置：{position} 脉冲")
    
    # 转换为圈数（17位编码器）
    rounds = position / 131072
    print(f"当前位置：{rounds:.2f} 圈")
```

### 🚀 JOG点动

```python
with L7Driver('COM3') as driver:
    driver.servo_on()
    
    # 正转
    driver.jog(speed=500, direction=True)
    time.sleep(2)  # 运行2秒
    
    # 反转
    driver.jog(speed=500, direction=False)
    time.sleep(2)  # 运行2秒
    
    # 停止
    driver.stop_jog()
    
    driver.servo_off()
```

### 🏠 自动回零

```python
with L7Driver('COM3') as driver:
    driver.servo_on()
    
    # 开始回零
    driver.home(mode=0, high_speed=500, low_speed=50)
    
    # 等待完成
    while not driver.is_homing_complete():
        print("回零中...")
        time.sleep(0.5)
    
    print("回零完成!")
    driver.servo_off()
```

### ⚡ 速度控制

```python
from leisai import L7Driver, ControlMode

with L7Driver('COM3') as driver:
    # 切换到速度模式
    driver.set_control_mode(ControlMode.SPEED)
    
    # 设置加减速时间
    driver.write_parameter('acceleration_time', 1000)  # 1秒
    driver.write_parameter('deceleration_time', 1000)  # 1秒
    
    driver.servo_on()
    
    # 设置速度
    driver.write_parameter('speed_command_1', 1000)  # 1000 RPM
    time.sleep(5)
    
    # 停止
    driver.write_parameter('speed_command_1', 0)
    time.sleep(2)
    
    driver.servo_off()
```

### ⚠️ 报警处理

```python
with L7Driver('COM3') as driver:
    # 检查报警
    alarm = driver.get_alarm()
    
    if alarm:
        print(f"发现报警：{driver.get_alarm_description(alarm)}")
        
        # 复位报警
        driver.reset_alarm()
        time.sleep(1)
        
        # 再次检查
        if driver.get_alarm() == 0:
            print("报警已清除")
    else:
        print("无报警")
```

### 💾 参数读写

```python
with L7Driver('COM3') as driver:
    # 读取参数
    rigidity = driver.read_parameter('rigidity_level')
    print(f"当前刚性：{rigidity}")
    
    # 写入参数
    driver.set_rigidity(20)  # 设置刚性为20
    driver.set_inertia_ratio(200)  # 设置惯量比200%
    
    # 保存到EEPROM（断电保持）
    driver.save_parameters()
    print("参数已保存")
```

## 三、完整示例程序

### 示例1：基础运动测试

```python
#!/usr/bin/env python
"""基础运动测试程序"""

from leisai import L7Driver
import time

def test_basic_motion():
    """测试基本运动功能"""
    
    with L7Driver('COM3', slave_id=1) as driver:
        print("=" * 50)
        print("雷赛L7伺服测试程序")
        print("=" * 50)
        
        # 1. 检查连接
        if not driver.is_connected:
            print("连接失败!")
            return
        print("✓ 连接成功")
        
        # 2. 检查报警
        alarm = driver.get_alarm()
        if alarm:
            print(f"✗ 有报警：{driver.get_alarm_description(alarm)}")
            driver.reset_alarm()
            time.sleep(1)
        else:
            print("✓ 无报警")
        
        # 3. 伺服使能
        driver.servo_on()
        print("✓ 伺服已使能")
        
        # 4. JOG测试
        print("\n开始JOG测试...")
        print("  正转500RPM - 3秒")
        driver.jog(500, True)
        time.sleep(3)
        
        print("  反转500RPM - 3秒")
        driver.jog(500, False)
        time.sleep(3)
        
        driver.stop_jog()
        print("✓ JOG测试完成")
        
        # 5. 读取最终位置
        final_pos = driver.get_position()
        print(f"\n最终位置：{final_pos} 脉冲")
        
        # 6. 伺服断使能
        driver.servo_off()
        print("✓ 伺服已断使能")
        
        print("\n测试完成！")

if __name__ == "__main__":
    test_basic_motion()
```

### 示例2：参数配置工具

```python
#!/usr/bin/env python
"""参数配置工具"""

from leisai import L7Driver
import json

def backup_parameters():
    """备份当前参数"""
    
    with L7Driver('COM3') as driver:
        print("读取参数中...")
        
        # 要备份的参数列表
        params_to_backup = [
            'rigidity_level',
            'inertia_ratio', 
            'position_loop_gain',
            'speed_loop_gain',
            'speed_loop_integral',
            'acceleration_time',
            'deceleration_time',
            'motor_max_speed'
        ]
        
        backup = {}
        for param in params_to_backup:
            value = driver.read_parameter(param)
            backup[param] = value
            print(f"  {param}: {value}")
        
        # 保存到文件
        with open('servo_backup.json', 'w') as f:
            json.dump(backup, f, indent=2)
        
        print(f"\n参数已备份到 servo_backup.json")

def restore_parameters():
    """恢复参数"""
    
    with L7Driver('COM3') as driver:
        # 读取备份文件
        with open('servo_backup.json', 'r') as f:
            backup = json.load(f)
        
        print("恢复参数中...")
        for param, value in backup.items():
            driver.write_parameter(param, value)
            print(f"  {param}: {value}")
        
        # 保存到EEPROM
        driver.save_parameters()
        print("\n参数已恢复并保存到EEPROM")

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) < 2:
        print("用法：")
        print("  python params.py backup  - 备份参数")
        print("  python params.py restore - 恢复参数")
    elif sys.argv[1] == "backup":
        backup_parameters()
    elif sys.argv[1] == "restore":
        restore_parameters()
```

### 示例3：状态监控器

```python
#!/usr/bin/env python
"""实时状态监控器"""

from leisai import L7Driver, AlarmCode
import time
import os

def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def monitor_servo():
    """实时监控伺服状态"""
    
    with L7Driver('COM3') as driver:
        driver.servo_on()
        
        try:
            while True:
                clear_screen()
                print("=" * 50)
                print("雷赛L7伺服状态监控器")
                print("=" * 50)
                
                # 读取状态
                position = driver.get_position()
                speed = driver.get_speed()
                torque = driver.get_torque()
                alarm = driver.get_alarm()
                
                # 显示状态
                print(f"\n位置: {position:8} 脉冲 ({position/131072:.2f} 圈)")
                print(f"速度: {speed:8} RPM")
                print(f"转矩: {torque:8} %")
                
                if alarm == AlarmCode.NO_ALARM:
                    print(f"报警: 无")
                else:
                    print(f"报警: {driver.get_alarm_description(alarm)}")
                
                # 状态指示
                print("\n状态: ", end="")
                if driver.is_ready():
                    print("✅ 就绪")
                else:
                    print("⚠️ 未就绪")
                
                print("\n按 Ctrl+C 退出")
                time.sleep(0.1)
                
        except KeyboardInterrupt:
            print("\n\n监控已停止")
            driver.servo_off()

if __name__ == "__main__":
    monitor_servo()
```

## 四、串口配置

### Windows系统

1. 打开设备管理器
2. 查看"端口(COM和LPT)"
3. 找到USB转串口设备，记下COM口号

### Linux系统

```bash
# 查看串口设备
ls /dev/tty*

# 通常是
/dev/ttyUSB0  # USB转串口
/dev/ttyACM0  # Arduino类设备

# 添加用户到dialout组（获取串口权限）
sudo usermod -a -G dialout $USER
# 注销重新登录生效
```

### 测试串口

```python
import serial.tools.list_ports

# 列出所有串口
ports = serial.tools.list_ports.comports()
for port in ports:
    print(f"{port.device}: {port.description}")

# 测试连接
from leisai import L7Driver

for port in ['COM3', 'COM4', 'COM5']:
    try:
        driver = L7Driver(port, timeout=0.5)
        if driver.connect():
            print(f"✓ {port} 连接成功")
            driver.disconnect()
            break
    except:
        print(f"✗ {port} 连接失败")
```

## 五、注意事项

### ⚡ 安全注意

1. **上电顺序**：先接线，后上电
2. **急停按钮**：确保急停按钮可用
3. **初次调试**：电机空载，低速测试
4. **参数修改**：先备份原参数

### 🔧 调试技巧

1. **通信问题**
   - 检查接线：A+/B-不要接反
   - 终端电阻：RS485需120Ω电阻
   - 波特率：默认38400

2. **报警处理**
   - 先记录报警代码
   - 排除故障原因
   - 复位报警重试

3. **性能优化**
   - 从低刚性开始调试
   - 使用自动调谐功能
   - 记录最佳参数组合

## 六、技术支持

- 📧 技术邮箱：support@leisai.com
- 📞 技术电话：0755-26433338
- 📖 完整文档：[README_CN.md](README_CN.md)
- 💻 示例代码：[examples/](examples/)

---

💡 **提示**：本指南包含最常用功能，更多高级功能请查看完整文档。