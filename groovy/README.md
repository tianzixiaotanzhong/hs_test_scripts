# Jenkins 自动禁用失败任务脚本

## 功能概述

该 Groovy 脚本用于自动监控 Jenkins 中的所有任务，当检测到某个任务连续失败达到指定次数时，自动禁用该任务并发送飞书通知。这有助于避免持续失败的任务浪费系统资源，并及时通知相关人员处理。

## 主要特性

- 🔍 **自动扫描**：扫描 Jenkins 中所有任务的构建历史
- 🚫 **智能禁用**：连续失败达到阈值后自动禁用任务
- 🔔 **飞书通知**：禁用任务时发送飞书消息通知
- 🛡️ **误禁保护**：检测用户手动触发的构建，避免重复禁用刚重新启用的任务
- 🧪 **试运行模式**：支持 DRY_RUN 模式，可先查看效果而不实际禁用

## 工作原理

1. 脚本遍历 Jenkins 中的所有任务
2. 检查每个任务最近的构建记录（默认最近10次）
3. 如果连续失败次数达到阈值，则：
   - 检查是否有用户手动触发的构建正在运行（避免误禁）
   - 如果不是手动触发，则禁用该任务
   - 发送飞书通知（如已配置）

### 触发类型识别

脚本会识别以下手动触发类型，对这些触发的构建提供保护：
- `UserIdCause`：用户在 Jenkins 界面点击"立即构建"
- `UserCause`：用户通过 API 触发
- `CLICause`：通过命令行触发
- `RemoteCause`：远程触发

定时触发（`TimerTriggerCause`）的构建不会被保护，确保真正有问题的定时任务能被正常禁用。

## 使用方法

### 1. 配置参数

编辑脚本顶部的可调参数：

```groovy
/********** 可调参数 **********/
int FAIL_THRESHOLD = 10    // 连续失败阈值，默认10次
boolean DRY_RUN = false    // 试运行模式，true时只输出日志不实际禁用
/*****************************/
```

### 2. 配置飞书通知（可选）

设置环境变量：
- `FEISHU_WEBHOOK`：飞书机器人的 Webhook URL
- `FEISHU_SECRET`：飞书机器人的签名密钥（可选）

可以通过以下方式设置：
- 系统环境变量
- Jenkins 全局环境变量（Manage Jenkins → Configure System → Global properties）

### 3. 运行脚本

#### 方式一：定时执行（推荐）

在 Jenkins 中创建一个定时任务：

1. 创建新任务，类型选择"自由风格的软件项目"
2. 在"构建触发器"中勾选"定时构建"
3. 设置 cron 表达式，例如每小时执行一次：`H * * * *`
4. 在"构建"中添加"执行系统 Groovy 脚本"
5. 将脚本内容粘贴进去

#### 方式二：手动执行

通过 Jenkins Script Console 执行：
1. 进入 Manage Jenkins → Script Console
2. 粘贴脚本内容
3. 点击"运行"

### 4. 查看日志

脚本执行时会输出详细日志：
- `OK: [任务名]`：任务正常，未达到失败阈值
- `跳过（已禁用）: [任务名]`：任务已被禁用，跳过检查
- `跳过（构建不足 N 次）: [任务名]`：构建历史不足，跳过检查
- `跳过（有用户手动触发的构建正在运行）: [任务名]`：检测到手动触发的构建，暂不禁用
- `⚠️ 连续失败 N 次，禁用 Job: [任务名]`：任务被禁用
- `[DRY_RUN] 将禁用 Job: [任务名]`：试运行模式下的模拟输出

## 飞书通知格式

当任务被禁用时，飞书通知内容如下：

```
⚠️ Jenkins Job 已被禁用
Job: 项目名称/任务名称
原因: 最近 10 次构建全部失败
链接: https://jenkins.example.com/job/xxx
时间: 2024-01-01 10:00:00
```

## 注意事项

1. **权限要求**：执行脚本的用户需要有禁用任务的权限
2. **试运行建议**：首次使用建议先设置 `DRY_RUN = true` 查看效果
3. **误禁恢复**：如果任务被误禁，可以手动在 Jenkins 界面重新启用
4. **手动触发保护**：当用户手动重新启用并触发构建时，脚本会检测并跳过禁用，避免重复禁用

## 常见问题

### Q: 任务被禁用后如何恢复？
A: 在 Jenkins 界面找到该任务，点击"启用"即可。建议先修复导致失败的问题再重新启用。

### Q: 如何调整失败阈值？
A: 修改脚本中的 `FAIL_THRESHOLD` 参数，例如改为 5 表示连续失败 5 次就禁用。

### Q: 飞书通知没有收到？
A: 检查：
1. 环境变量 `FEISHU_WEBHOOK` 是否正确配置
2. 飞书机器人是否正常工作
3. 如配置了签名，检查 `FEISHU_SECRET` 是否正确

### Q: 定时任务每次都被重复禁用？
A: 最新版本已解决此问题。脚本会检测正在运行的构建是否为手动触发，如果是则跳过禁用。

## 版本历史

- **v1.2** - 添加手动触发检测，避免重复禁用刚重新启用的任务
- **v1.1** - 添加飞书通知功能
- **v1.0** - 基础功能：自动禁用连续失败的任务

## 技术支持

如有问题或建议，请联系 Jenkins 管理员。